---
title: "supervised"
author: "Manunpat"
date: "2022-12-11"
output: html_document
---
```{r,include=FALSE}
source(here::here("scripts/setup.R"))
```

# LSA LDA
# Supervised learning(LSA on TF)
First, we use LSA on TF to have a reduced dimension version of the DFM and build a random forest model to predict the category from the LSA.

We build our data frame consisting of the category and the “doc” matrix of the LSA. Along with this, we build the training set index based on a 80/20 split.
```{r}
a <- c(1:1471)
row.names(TED.lsa.source) <- a
TED.lsa.source$cate <- as.factor(TED.lsa.source$cate) 
```


```{r}
set.seed(123)
index.tr <- createDataPartition(y = TED.lsa.source$cate, p= 0.8, list = FALSE)
TED.tr <- TED.lsa.source[index.tr,]
TED.te <- TED.lsa.source[-index.tr,]
```

## Balance the data
The data is unbalanced so We need to use the sub-sampling method to balance the data.
```{r}
table(TED.tr$cate)
```


```{r}
set.seed(123)
n2 <- min(table(TED.tr$cate)) ## 327

TED.tr.1 <- filter(TED.tr, cate=="1") ## the category 1
TED.tr.2 <- filter(TED.tr, cate=="2") ## the category 2
TED.tr.3 <- filter(TED.tr, cate=="3") ## the category 3
index.1 <- sample(size=n2, x=1:nrow(TED.tr.1), replace=FALSE)
index.3 <- sample(size=n2, x=1:nrow(TED.tr.3), replace=FALSE)
TED.tr.subs <- data.frame(rbind(TED.tr.1[index.1,], 
                                TED.tr.2,
                                TED.tr.3[index.3,]))
```


```{r}
table(TED.tr.subs$cate)
```
We now use a random forest to predict the category from the LSA on TF. The resulting accuracy is inspected on the test set.
```{r}
TED.fit <- ranger(TED.tr.subs$cate ~ ., 
                     data = TED.tr.subs[2:6])
pred.te <- predict(TED.fit, TED.te)
confusionMatrix(data=pred.te$predictions, reference = TED.te$cate)
```
According to the confusion matrix, the accuracy is *0.8089* and the balanced accuracy for class 1 is *0.8340*, for class 2 is *0.8911*, and for class 3 is *0.8576*.

# Supervised learning(LSA on TF-IDF)
Now we repeat the steps and use LSA on TF-IDF to have a reduced dimension version of the DFM and build a random forest model to predict the category from the LSA.
```{r}
TED.lsa2.source <- cbind(document,TED.lsa2.source)
row.names(TED.lsa2.source) <- a
TED.lsa2.source$cate <- as.factor(TED.lsa2.source$cate)
```

```{r}
set.seed(123)
index.tr <- createDataPartition(y = TED.lsa2.source$cate, p= 0.8, list = FALSE)
TED.tr <- TED.lsa2.source[index.tr,]
TED.te <- TED.lsa2.source[-index.tr,]
```

```{r}
n2 <- min(table(TED.tr$cate)) ## 327

TED.tr.1 <- filter(TED.tr, cate=="1") ## the category 1
TED.tr.2 <- filter(TED.tr, cate=="2") ## the category 2
TED.tr.3 <- filter(TED.tr, cate=="3") ## the category 3
index.1 <- sample(size=n2, x=1:nrow(TED.tr.1), replace=FALSE)
index.3 <- sample(size=n2, x=1:nrow(TED.tr.3), replace=FALSE)
TED.tr.subs <- data.frame(rbind(TED.tr.1[index.1,], 
                                TED.tr.2,
                                TED.tr.3[index.3,]))
```


```{r}
TED.fit2 <- ranger(TED.tr.subs$cate ~ ., 
                     data = TED.tr.subs[2:6])
pred.te <- predict(TED.fit2, TED.te)
confusionMatrix(data=pred.te$predictions, reference = TED.te$cate)
```
According to the confusion matrix, the model build on features using LSA on TF-ITF is better than the model build on features using LSA on TF. The accuracy is *0.8805* and the balanced accuracy for class 1 is *0.8897*, for class 2 is *0.9317*, and for class 3 is *0.9156*.

# Embeding 
# Supervised learning
```{r}
row.names(TED.de.source) <- a
TED.de.source$cate <- as.factor(TED.de.source$cate) 
```


```{r}
set.seed(123)

TED.Emb.tr <- TED.de.source[index.tr,]
TED.Emb.te <- TED.de.source[-index.tr,]
```

```{r}
table(TED.tr$cate)
```


```{r}
set.seed(123)
n2 <- min(table(TED.tr$cate)) ## 327

TED.Emb.tr.1 <- filter(TED.Emb.tr, cate=="1") ## the category 1
TED.Emb.tr.2 <- filter(TED.Emb.tr, cate=="2") ## the category 2
TED.Emb.tr.3 <- filter(TED.Emb.tr, cate=="3") ## the category 3
index.1 <- sample(size=n2, x=1:nrow(TED.Emb.tr.1), replace=FALSE)
index.3 <- sample(size=n2, x=1:nrow(TED.Emb.tr.3), replace=FALSE)
TED.Emb.tr.subs <- data.frame(rbind(TED.Emb.tr.1[index.1,], 
                                TED.Emb.tr.2,
                                TED.Emb.tr.3[index.3,]))
```

```{r}
set.seed(123)
TED.Emb.fit <- ranger(TED.Emb.tr.subs$cate~., 
                      data = TED.Emb.tr.subs)
pred.Emb.te <- predict(TED.Emb.fit, TED.Emb.te)
confusionMatrix(data=pred.Emb.te$predictions, reference = TED.Emb.te$cate)
```

# Combine LSA(TF-IDF), embeding, likes, and views for supervised learning

```{r}
TED.de.source <- TED.de.source %>% 
  rename(V5=V1,V6=V2)
TED.LSA.Emb <- TED.lsa2.source %>% 
  cbind(TED.de.source) %>% 
  select(-7)
```


```{r}
TED.Com.tr <- TED.LSA.Emb[index.tr,]
TED.Com.te <- TED.LSA.Emb[-index.tr,]
```

```{r}
set.seed(123)
TED.Com.tr.1 <- filter(TED.Com.tr, cate=="1") ## the category 1
TED.Com.tr.2 <- filter(TED.Com.tr, cate=="2") ## the category 2
TED.Com.tr.3 <- filter(TED.Com.tr, cate=="3") ## the category 3
index.1 <- sample(size=n2, x=1:nrow(TED.Com.tr.1), replace=FALSE)
index.3 <- sample(size=n2, x=1:nrow(TED.Com.tr.3), replace=FALSE)
TED.Com.tr.subs <- data.frame(rbind(TED.Com.tr.1[index.1,],
                                    TED.Com.tr.2,
                                    TED.Com.tr.3[index.3,]))
```


```{r}
set.seed(123)
TED.Com.fit <- ranger(TED.Com.tr.subs$cate~.,
                      data = TED.Com.tr.subs[2:10])
pred.Com.te <- predict(TED.Com.fit, TED.Com.te)
confusionMatrix(data=pred.Com.te$predictions, reference = TED.Com.te$cate)
```


