---
title: "web"
author: "Jiaming"
date: "2022-11-17"
output: html_document
---

```{r,include=FALSE}
source(here::here("scripts/setup.R"))
```

```{r bbc web}
rD <- rsDriver(browser="chrome", port=444L, verbose=F)

remDr <- rD$client
url <- "https://www.ted.com/"
remDr$navigate(url)
remDr$maxWindowSize()

html_page <- remDr$getPageSource()[[1]]
```


```{r}
# go to TED talk
drop_down <- remDr$findElement(using = 'xpath', '//*[@id="menu-button--0"]/div')
remDr$mouseMoveToLocation(webElement=drop_down)
remDr$findElement(using = 'xpath', '//*[@id="option-0--0"]/div[1]')$clickElement()
Sys.sleep(2)

# select lanuage to english
drop_down <- remDr$findElement(using = 'xpath', '//*[@id="languages"]')
remDr$mouseMoveToLocation(webElement=drop_down)
remDr$click(2)
remDr$findElement(using = "xpath", '//*[@id="languages"]/optgroup/option[1]')$clickElement()
Sys.sleep(2)

# select duration as 6-12 mins
drop_down <- remDr$findElement(using = 'xpath', '//*[@id="filters"]/div[1]/div/div[2]/div[1]/div[1]/div/div[2]/div/div[3]/select')
remDr$mouseMoveToLocation(webElement=drop_down)
remDr$click(2)
remDr$findElement(using = "xpath", '//*[@id="filters"]/div[1]/div/div[2]/div[1]/div[1]/div/div[2]/div/div[3]/select/option[3]')$clickElement()
Sys.sleep(2)

# select sort by the most viewed
drop_down <- remDr$findElement(using = 'xpath', '//*[@id="filters-sort"]')
remDr$mouseMoveToLocation(webElement=drop_down)
remDr$click(2)
remDr$findElement(using = "xpath", '//*[@id="filters-sort"]/optgroup/option[4]')$clickElement()

```


```{r}
# first crawl all videos' titles on the first page
html_page <- remDr$getPageSource()[[1]]

page <- 2

title <- as.character()
speaker <- as.character()
views_times <- as.character()
page_num <- as.character()

for (i in 1:page) {
  
  page_title <- read_html(html_page) %>% 
    html_nodes(xpath = "//*[@id='browse-results']/div[1]/div/div/div/div/div[2]/h4[2]/a") %>% 
    html_text() 
  page_title <- gsub("\n","", page_title)
  #there are 36 videos in one page
  
  page_speaker <- read_html(html_page) %>% 
    html_nodes(xpath = "//*[@id='browse-results']/div[1]/div/div/div/div/div[2]/h4[1]") %>% 
    html_text() 
  
  page_views_times <- read_html(html_page) %>% 
    html_nodes(xpath = "//*[@id='browse-results']/div[1]/div/div/div/div/div[2]/div/span/span") %>% 
    html_text() 
  page_views_times <- gsub("\n","", page_views_times)
  
  page_page <- rep(i, times=length(page_title))
  
  next_page <- remDr$findElement(using = 'xpath', '//*[@id="browse-results"]/div[2]/div/a[6]')
  remDr$mouseMoveToLocation(webElement=next_page)
  remDr$click(2)
  Sys.sleep(5)
  
  html_page <- remDr$getPageSource()[[1]]
  
  title <- append(title, page_title)
  speaker <- append(speaker, page_speaker)
  views_times <- append(views_times, page_views_times)
  page_num <- append(page_num, page_page)

}

browse_result <- data.frame(
  "page" = page_num,
  "title" = title,
  "speaker" = speaker,
  "views_times" = views_times
)

first_page <- remDr$findElement(using = 'xpath', '//*[@id="browse-results"]/div[2]/div/a[2]')
  remDr$mouseMoveToLocation(webElement=first_page)
  remDr$click(2)
  Sys.sleep(3)
html_page <- remDr$getPageSource()[[1]]

```

```{r}
#click in each video to capture infos

introduction <- as.character()
likes <- as.character()
tanscript <- as.character()
title_re <- as.character()

for ( num in 1:page) {
  
  sub_browse_result <- browse_result %>% filter(page_num == num)
  n <- length(sub_browse_result$title)
  
  for (i in 1:n) {
    
    Sys.sleep(2)
    
    # click in the video
    video_page <- remDr$findElement(using = 'partial link text', sub_browse_result$title[i])
    remDr$mouseMoveToLocation(webElement=video_page)
    remDr$click(2)
    Sys.sleep(10)
    
    video_title <- sub_browse_result$title[i]
    
    # open transcript
    drop_down <- remDr$findElement(using = 'xpath', "//*[@id='maincontent']/div/div/div/div/div[2]/div[3]/div[2]/button")
    remDr$mouseMoveToLocation(webElement=drop_down)
    remDr$click(2)
    Sys.sleep(5)
    
    # begin to crawl infos
    html_page <- remDr$getPageSource()[[1]]
    
    video_sum <- read_html(html_page) %>% 
      html_nodes(xpath = "//*[@id='maincontent']/div/div/div/div/div[2]/div[3]/div[1]/div[2]/div/div") %>% 
      html_text() 
    video_sum <- video_sum[1]
    Sys.sleep(3)
    
    video_likes <- read_html(html_page) %>% 
      html_nodes(xpath = "//*[@id='maincontent']/div/div/div/div/div[2]/div[1]/div[3]/button[1]/div/div/span") %>% html_text() 
    Sys.sleep(3)
    
    video_tanscript <- read_html(html_page) %>% 
      html_nodes(xpath = "//*[@id='maincontent']/div/div/div/aside/div[2]/div[2]/div/div/div[1]/div[3]") %>%
      html_text() 
    Sys.sleep(3)
    
    remDr$goBack()
    Sys.sleep(5)
    
    introduction <- append(introduction, video_sum)
    likes <- append(likes,video_likes)
    tanscript <- append(tanscript, video_tanscript)
    title_re <- append(title_re, video_title)
  
  }
  
  next_page <- remDr$findElement(using = 'xpath', '//*[@id="browse-results"]/div[2]/div/a[6]')
  remDr$mouseMoveToLocation(webElement=next_page)
  remDr$click(2)
  Sys.sleep(5)
  
}

video_info <- data.frame(
  
  "title" = title_re,
  "introduction" = introduction,
  "likes" = likes,
  "tanscript" = tanscript
)
```


```{r}
TED <- left_join(browse_result, video_info, by="title")
```




```{r, include=FALSE}
remDr$closeServer()
remDr$close()
rm(remDr)
rm(rD)
gc()
```